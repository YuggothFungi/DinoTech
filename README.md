# DinoTech

Good dinosaurs code, great dinosaurs vibecode.

# PWA-приложение для оперативного управленческого учёта товаров, себестоимости и цен в кофейне

---

## 0. Цель и философия системы

Система предназначена для **оперативного управленческого учёта** в кофейне с фокусом на:

* быстрые и понятные действия с экрана телефона;
* прозрачный и воспроизводимый расчёт себестоимости;
* мгновенную оценку влияния изменения цен;
* минимальный ввод данных без складской и бухгалтерской сложности.

Система **не является**:

* бухгалтерией;
* складской системой (WMS);
* кассовым ПО.

Она фиксирует управленческие факты и поддерживает принятие решений.

---

## 1. Ключевые сценарии использования

### Сценарий A. Создание напитка (manufactured)

1. Пользователь создаёт **Product** типа `manufactured` (например, «Капучино 300 мл»).
2. Назначает категорию.
3. Создаёт **TechCard**:

   * указывает выход продукта (300 мл);
   * задаёт ингредиенты и их количества.
4. Назначает упаковку:

   * стакан 300 мл ×1;
   * крышка большая ×1.
5. Выполняет предварительный расчёт себестоимости (preview).
6. Фиксирует расчёт (создаётся **CostCalculation**).
7. Задаёт цену продажи через модель ценообразования.

---

### Сценарий B. Приёмка поставки сырья или resale-товара

1. Пользователь получает накладную (номер и дата сохраняются как текстовые атрибуты).
2. Вводит цену поставки:

   * цену за упаковку поставки;
   * количество или объём в упаковке.
3. Система нормализует цену к базовой единице хранения (`baseUnit`).
4. Обновляется текущая цена соответствующей сущности.
5. Создаётся **PriceRecord** как событие изменения цены.

Система не ведёт учёт партий и остатков.

---

### Сценарий C. Изменение цены и анализ влияния

1. Пользователь меняет цену сырья, упаковки или resale-товара.
2. Система строит граф зависимостей:

   * RawMaterial → TechCardIngredient → TechCard → Product;
   * Packaging → ProductPackaging → Product.
3. Для каждого затронутого продукта рассчитывается preview-себестоимость.
4. Пользователь принимает решение о фиксации новых расчётов.

---

### Сценарий D. Изменение упаковки без изменения рецепта

1. Пользователь изменяет упаковку товара.
2. TechCard не изменяется.
3. Себестоимость пересчитывается с учётом новой упаковки.

---

### Сценарий E. Работа офлайн

1. Пользователь открывает PWA без интернета.
2. Управляет товарами, ценами, техкартами и упаковкой.
3. Выполняет расчёты локально.
4. При появлении сети данные синхронизируются.

---

## 2. Основные бизнес-правила

### 2.1. Базовые единицы измерения

* Каждая сущность, имеющая цену, имеет базовую единицу хранения (`baseUnit`).
* Любая вводимая цена приводится к `baseUnit`.
* Все расчёты выполняются только в `baseUnit`.

---

### 2.2. Цена и история изменений

* В системе всегда существует **текущая цена**.
* При изменении цены:

  * создаётся новый **PriceRecord**;
  * предыдущая цена сохраняется как `oldPrice`;
  * новая цена становится `currentPrice`.

**PriceRecord** — журнал изменений, а не источник истины.

---

### 2.3. Устаревшая себестоимость

Себестоимость товара считается устаревшей (`isOutdated = true`), если:

* изменилась цена любого используемого сырья;
* изменилась цена упаковки;
* изменилась TechCard;
* изменилась упаковка товара.

---

## 3. Доменная модель (сущности и атрибуты)

### 3.1. Product

Товар — всё, что продаётся клиенту.

```ts
Product {
  id
  name
  type            // manufactured | resale
  categoryId
  isActive
}
```

Примечания:

* Product **не хранит цену закупки как поле**.
* Цена закупки resale-товаров хранится через PriceRecord.

---

### 3.2. Category

Иерархическая группировка товаров.

```ts
Category {
  id
  name
  parentId?
}
```

---

### 3.3. RawMaterial

Сырьё, используемое в производстве.

```ts
RawMaterial {
  id
  name
  baseUnit        // g | ml | pcs
  isActive
}
```

---

### 3.4. Packaging

Упаковка (стаканы, крышки и др.).

```ts
Packaging {
  id
  name
  type            // CUP | LID | OTHER
  volume?         // ml, если применимо
  baseUnit        // pcs
  isActive
}
```

---

### 3.5. TechCard

Рецептура товара типа `manufactured`.

```ts
TechCard {
  id
  productId       // 1:1 с Product
  outputQuantity
  outputUnit      // ml | g | pcs
  processDescription?
  isActive
}
```

---

### 3.6. TechCardIngredient

Связь TechCard и RawMaterial.

```ts
TechCardIngredient {
  id
  techCardId
  rawMaterialId
  quantity
  unit            // g | ml | pcs
  wasteFactor?
}
```

---

### 3.7. ProductPackaging

Связь Product и Packaging.

```ts
ProductPackaging {
  id
  productId
  packagingId
  quantity        // обычно 1
}
```

---

### 3.8. PriceRecord

История изменения цен для разных сущностей.

```ts
PriceRecord {
  id
  entityType      // RAW_MATERIAL | PACKAGING | PRODUCT_RESALE | PRODUCT_SALE
  entityId
  oldPrice
  newPrice
  baseUnit
  metadata        // pricingModel, markupPercent, marginValue и др.
  changedAt
}
```

---

### 3.9. CostCalculation

Зафиксированная себестоимость товара.

```ts
CostCalculation {
  id
  productId
  totalCost
  calculatedAt
  breakdown       // IngredientsCost, PackagingCost
  isOutdated
}
```

---

## 4. Алгоритмы расчёта себестоимости

### 4.1. Manufactured-товары

```
TotalCost = IngredientsCost + PackagingCost
```

**IngredientsCost**:

1. Получить активную TechCard.
2. Для каждого TechCardIngredient:

   * определить актуальную цену RawMaterial;
   * привести единицы измерения;
   * учесть wasteFactor.
3. Сложить стоимость ингредиентов.

**PackagingCost**:

1. Получить все ProductPackaging.
2. Для каждого элемента упаковки:

   * получить актуальную цену Packaging;
   * умножить на quantity.
3. Сложить стоимость упаковки.

---

### 4.2. Resale-товары

```
TotalCost = PurchasePrice
```

Где PurchasePrice — текущая цена Product(resale), полученная через PriceRecord.

---

## 5. Ценообразование

Поддерживаемые модели:

```ts
PricingModel = MARKUP | ABSOLUTE_MARGIN
```

Формулы:

* MARKUP: `salePrice = totalCost × (1 + markupPercent)`
* ABSOLUTE_MARGIN: `salePrice = totalCost + marginValue`

Параметры хранятся в `PriceRecord.metadata`.

---

## 6. Роли и безопасность (для проектирования интерфейса)

### Owner / Manager

* создание и редактирование товаров;
* изменение цен;
* управление техкартами и упаковкой;
* фиксация себестоимости;
* управление ценами продажи.

### Staff

* ввод цен по накладным;
* просмотр товаров, цен и себестоимости;
* без доступа к рецептурам и ценообразованию.

---

## 7. Архитектура и хранение данных

### Backend

* хранит канонические данные;
* обеспечивает целостность;
* выполняет финальные расчёты;
* хранит историю изменений.

### Frontend (PWA)

* локальное хранилище (RxDB);
* офлайн-режим;
* синхронизация push/pull.

Схемы хранения являются реализационной деталью и могут эволюционировать.

---

## 8. Итоговые принципы

* Цена — событие, а не просто поле.
* Себестоимость фиксируется и не пересчитывается задним числом.
* Упаковка и рецептура — независимые домены.
* RawMaterial и Product(resale) используют единый механизм цен.
* Система оптимизирована под мобильный оперативный учёт.
