# DinoTech

Good dinosaurs code, great dinosaurs vibecode.

# Архитектура PWA‑приложения для управления товарами, техкартами, упаковкой и себестоимостью

---

## 0. Ключевые сценарии использования (с чего начинается работа с системой)

Этот раздел описывает **что именно можно сделать с помощью приложения**. Он является опорным: все остальные разделы спецификации обязаны быть с ним согласованы.

### Сценарий A. Создание нового напитка (manufactured) с упаковкой

1. Пользователь создаёт **Product** типа `manufactured` (например, «Капучино 300 мл»).
2. Пользователь назначает товару **категорию** (Напитки → Кофе → Классический).
3. Пользователь создаёт **TechCard**, указывая:

   * выход продукта (300 мл);
   * ингредиенты (кофе, молоко и т.д.).
4. Пользователь настраивает **упаковку товара**:

   * стакан 300 мл (1 шт);
   * крышка большая (1 шт).
5. Система может выполнить **предварительный расчёт себестоимости** (preview).
6. Пользователь фиксирует расчёт, создавая **CostCalculation**.
7. Пользователь задаёт **цену продажи** через модель ценообразования (наценка или фиксированная маржа).

---

### Сценарий B. Изменение упаковки без изменения рецептуры

1. Поставщик стаканчиков меняется, появляется новая цена.
2. Пользователь вводит новый **PriceRecord** для соответствующего Packaging.
3. Система показывает список товаров, где изменилась себестоимость **из‑за упаковки**.
4. Пользователь выполняет массовый пересчёт себестоимости.
5. Рецептуры (TechCard) при этом **не меняются**.

---

### Сценарий C. Изменение объёма напитка

1. Пользователь создаёт новый **Product** (например, «Капучино 400 мл»).
2. К нему может быть:

   * переиспользована TechCard с другими коэффициентами;
   * назначена другая упаковка (стакан 400 мл + крышка большая).
3. Себестоимость и цена продажи считаются независимо от версии 300 мл.

---

### Сценарий D. Подорожало сырьё или упаковка

1. Пользователь вводит новый **PriceRecord** (сырьё или упаковка).
2. Система определяет затронутые товары.
3. Пользователь:

   * просматривает изменение себестоимости (preview);
   * принимает решение о пересчёте;
   * при необходимости обновляет цены продажи.

---

### Сценарий E. Работа офлайн

1. Пользователь открывает PWA без сети.
2. Управляет товарами, техкартами, упаковкой.
3. Выполняет расчёты себестоимости локально.
4. При появлении сети изменения синхронизируются.

---

## 1. Общее описание

**Цель**: создание прогрессивного веб‑приложения (PWA) для управления ассортиментом товаров кофейни, технологическими картами, упаковкой, закупочными ценами и расчётом себестоимости и цен продажи с поддержкой офлайн‑режима и синхронизации.

Система ориентирована на **управленческий и операционный учёт**, а не на бухгалтерский или складской.

---

## 2. Доменная модель (ключевые понятия)

### 2.1. Product (товар)

Центральная сущность системы — всё, что продаётся клиенту.

Типы:

* `manufactured` — производится по техкарте;
* `resale` — перепродаётся без переработки.

---

### 2.2. Category (категория)

Иерархическая группировка товаров для навигации и аналитики.

---

### 2.3. RawMaterial (сырьё)

Закупаемые материалы, используемые в производстве.

---

### 2.4. Packaging (упаковка)

**Packaging** — отдельный домен, не являющийся ингредиентом.

Примеры:

* стакан 200 / 300 / 400 мл;
* крышка маленькая / большая;
* трубочка, мешалка.

Один товар может использовать **несколько упаковочных элементов**.

---

### 2.5. TechCard (технологическая карта)

Описывает рецептуру для товаров типа `manufactured`.

---

### 2.6. PriceRecord (универсальная цена)

Единая версионированная сущность для:

* сырья;
* перепродаваемых товаров;
* упаковки;
* цены продажи.

---

### 2.7. CostCalculation (себестоимость)

Зафиксированный результат расчёта себестоимости товара на конкретную дату.

---

## 3. Инварианты упаковки (обязательные правила)

1. Товар может иметь **0..N упаковочных элементов**.
2. Для напитков обязателен минимум один элемент типа `CUP`.
3. Упаковка не входит в TechCard и не влияет на рецептуру.
4. Изменение упаковки **не меняет версию TechCard**.

---

## 4. Алгоритм расчёта себестоимости (с упаковкой)

### 4.1. Общая формула

```
TotalCost = IngredientsCost + PackagingCost
```

---

### 4.2. IngredientsCost (manufactured)

1. Найти активную TechCard.
2. Для каждого ингредиента:

   * определить цену сырья на дату расчёта;
   * привести единицы измерения;
   * учесть wasteFactor.
3. Сложить стоимости ингредиентов.

---

### 4.3. PackagingCost

1. Найти все Packaging, связанные с Product.
2. Для каждого элемента упаковки:

   * найти актуальную цену;
   * умножить на quantity.
3. Сложить стоимость упаковки.

---

### 4.4. Resale‑товары

Для товаров типа `resale`:

```
TotalCost = PurchasePrice
```

(упаковка считается включённой в закупочную цену, если не указано иначе).

---

## 5. Ценообразование

Поддерживаются модели:

1. **Markup**: `salePrice = cost * (1 + markupPercent)`
2. **Absolute margin**: `salePrice = cost + marginValue`

Модель и параметры хранятся в `PriceRecord.metadata`.

---

## 6. Хранение данных (высокоуровнево)

### Backend (PostgreSQL)

* Хранит канонические данные.
* Гарантирует целостность и версионирование.
* Выполняет финальные расчёты и валидации.

### Frontend (RxDB)

* Хранит локальные копии данных.
* Поддерживает офлайн‑режим.
* Синхронизируется с сервером через push/pull.

Схемы БД и RxDB считаются **реализационной деталью** и могут эволюционировать без изменения доменной модели.

---

## 7. Архитектурные принципы

* Product — центральная сущность.
* TechCard и Packaging — независимые домены.
* Все цены версионируются во времени.
* Себестоимость фиксируется и не пересчитывается задним числом.
* Система решает управленческие задачи, а не бухгалтерские.

---

## 8. Масштабирование

Модель поддерживает:

* несколько точек продаж;
* разные поставщики;
* изменение упаковки без изменения рецептуры;
* аналитику маржи и чувствительности к ценам.
